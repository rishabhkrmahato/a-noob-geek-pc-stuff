# Creates a zip on the desktop with a text file of past BSOD details and minidump files named by date. 
# Use a BSOD viewer to analyze and get more details online.

# Check for administrative privileges
If (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    [System.Windows.Forms.MessageBox]::Show("Please run this script as Administrator.", "Administrator Privileges Required", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Warning) | Out-Null
    Exit
}

# Output file and folder setup
$Desktop = [Environment]::GetFolderPath('Desktop')
$OutputFile = "$Desktop\bsod-details.txt"
$OutputFolder = "$Desktop\bsod-details"

# Create output folder if it doesn't exist
If (-Not (Test-Path -Path $OutputFolder)) {
    New-Item -Path $OutputFolder -ItemType Directory | Out-Null
}

# Fetch BSOD details
Write-Host "Fetching BSOD details from Event Logs..." -ForegroundColor Yellow
$BSODEvents = Get-WinEvent -LogName System | Where-Object { $_.Id -eq 1001 }

# Process and write BSOD details to the file
If ($BSODEvents) {
    Write-Host "Writing BSOD details to $OutputFile..." -ForegroundColor Yellow
    $BSODEvents | ForEach-Object {
        $EventTime = $_.TimeCreated.ToString()
        $Message = $_.Message
        "$EventTime - $Message`n" | Out-File -Append -FilePath $OutputFile -Encoding UTF8
    }
    Write-Host "BSOD details saved successfully!" -ForegroundColor Green
} Else {
    Write-Host "No BSOD events found in Event Logs." -ForegroundColor Cyan
    Exit
}

# Copy and rename Minidump files
$MinidumpFolder = "C:\Windows\Minidump"
If (Test-Path -Path $MinidumpFolder) {
    Write-Host "Copying Minidump files to $OutputFolder with date-appended names..." -ForegroundColor Yellow
    Get-ChildItem -Path $MinidumpFolder -Filter *.dmp | ForEach-Object {
        $OriginalFile = $_.FullName
        $FileNameWithoutExtension = $_.BaseName
        $DateSuffix = $_.CreationTime.ToString("yyyyMMdd")
        $NewFileName = "$FileNameWithoutExtension-$DateSuffix.dmp"
        $DestinationPath = Join-Path $OutputFolder $NewFileName
        Copy-Item -Path $OriginalFile -Destination $DestinationPath
    }
    Write-Host "Minidump files copied and renamed successfully!" -ForegroundColor Green
} Else {
    Write-Host "No Minidump folder found at $MinidumpFolder." -ForegroundColor Red
}

# Move BSOD details text file into the output folder
Write-Host "Moving $OutputFile to $OutputFolder..." -ForegroundColor Yellow
Move-Item -Path $OutputFile -Destination $OutputFolder

# Archive the folder to a ZIP file using native Windows tools
$ZipFile = "$Desktop\bsod-details.zip"
Write-Host "Archiving $OutputFolder to $ZipFile..." -ForegroundColor Yellow
Compress-Archive -Path $OutputFolder -DestinationPath $ZipFile -CompressionLevel Optimal

# Delete the original folder
Write-Host "Deleting the original folder $OutputFolder..." -ForegroundColor Yellow
Remove-Item -Path $OutputFolder -Recurse

Write-Host "BSOD details and Minidump files archived successfully at $ZipFile!" -ForegroundColor Green
